# Load required packages
if (!requireNamespace("writexl", quietly = TRUE)) install.packages("writexl")
library(writexl)
library(dplyr)
library(effectsize)
# Function to extract fixed effects formula (without random effects)
extract_fixed_formula <- function(model) {
full_formula <- formula(model)
# Extract just the fixed effects part (before the | symbol)
fixed_part <- as.character(full_formula)[3]
fixed_part <- gsub("\\s*\\+\\s*\\([^)]*\\|[^)]*\\)", "", fixed_part)
response <- as.character(full_formula)[2]
paste(response, "~", fixed_part)
}
# Function to compile model statistics
get_model_stats <- function(model, effect_name = NULL, emmeans_result = NULL) {
# Get ANOVA table
anova_table <- anova(model)
if (!is.null(effect_name)) {
# Extract specific effect
effect_row <- anova_table[effect_name, ]
# Calculate effect size (partial eta squared)
eta_sq <- effectsize::eta_squared(model, partial = TRUE)
effect_eta <- eta_sq[eta_sq$Parameter == effect_name, "Eta2_partial"]
stats_string <- sprintf(
"F(%d, %.2f) = %.2f, p = %.4f, η²p = %.3f",
effect_row$NumDF,
effect_row$DenDF,
effect_row$`F value`,
effect_row$`Pr(>F)`,
effect_eta
)
} else {
# If no specific effect, return full ANOVA table summary
stats_string <- paste(capture.output(print(anova_table)), collapse = "\n")
}
# Add emmeans results if provided
if (!is.null(emmeans_result)) {
emmeans_summary <- paste(capture.output(print(emmeans_result)), collapse = "\n")
stats_string <- paste(stats_string, "\n\nPost-hoc:\n", emmeans_summary)
}
return(stats_string)
}
# Initialize results list
results_list <- list()
# =========================
# Your Models
# =========================
## -------- acquisition: CS * TUS * TRIAL --------
res_acq_triple <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
source(here::here("stats","lme_models","_setup.R"))
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
source(here::here("stats","lme_models","_setup.R"))
source(here::here("stats","lme_models","pipeline","run_lmer_test.R"))
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
source(here::here("stats","lme_models","_setup.R"))
## -------- acquisition: CS * TUS * TRIAL --------
res_acq_triple <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
# Emtrends on TRIAL by TUS within CS
trend_results <- emtrends(res_acq_triple$model,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
trend_results
View(scr_df)
tol <- 1e-6  # tolerance for tiny floating-point differences
scr_df_check_transform <- scr_df %>%
mutate(diff = SCR_sqrt - sqrt(SCR)) %>%
summarise(
max_abs_diff = max(abs(diff), na.rm = TRUE),
n_mismatch   = sum(abs(diff) > tol, na.rm = TRUE)
)
scr_df_check_transform
scr_df_scr_checks <- scr_df %>%
summarise(
min_SCR      = min(SCR, na.rm = TRUE),
n_negative   = sum(SCR < 0,    na.rm = TRUE),
n_below_001  = sum(SCR < 0.01, na.rm = TRUE)
)
scr_df_scr_checks
scr_df %>%
summarise(
min_SCR_sqrt = min(SCR_sqrt, na.rm = TRUE),
n_neg_sqrt   = sum(SCR_sqrt < 0, na.rm = TRUE),
n_na_sqrt    = sum(is.na(SCR_sqrt))
)
## -------- acquisition: CS * TUS * TRIAL --------
res_acq_triple <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
# Emtrends on TRIAL by TUS within CS
trend_results <- emtrends(res_acq_triple$model,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
trend_results
## -------- acquisition: CS * TUS (TIME: early/mid/late) --------
# early
res_acq_early <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
effect_name = "CS:TUS"
)
View(scr_df)
View(dfs)
emm <- emmeans(res_acq_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise")
cn
# mid
run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS_mid",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
effect_name = "CS:TUS"
)
# late
run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
effect_name = "CS:TUS"
)
str(scr_df)
scr_df <- as.factor(scr_df$SUBID)
str(scr_df)
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
source(here::here("stats","lme_models","_setup.R"))
## -------- acquisition: CS * TUS * TRIAL --------
res_acq_triple <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
source(here::here("stats","lme_models","_setup.R"))
## -------- acquisition: CS * TUS * TRIAL * EXPERIMENT --------
res_acq_4way <- run_lmer_test(
data_name   = "scr_df_exp_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL * EXPERIMENT + (1 + CS + TUS + TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL:EXPERIMENT"
)
## -------- acquisition (TIME: early) : CS * TUS * EXPERIMENT --------
res_acq_time_early <- run_lmer_test(
data_name   = "scr_df_exp_acq_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS * EXPERIMENT + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS:EXPERIMENT"
)
# emmeans & contrast
emm <- emmeans(res_acq_time_early$model, ~ CS * TUS * EXPERIMENT, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
aov_tab <- anova(res_acq_time_early$model)
effectsize::eta_squared(aov_tab, partial = TRUE)
scr_df %>%
dplyr::summarise(
n_zero        = sum(SCR == 0, na.rm = TRUE),
n_between_001 = sum(SCR > 0 & SCR < 0.01, na.rm = TRUE)
)
scr_df %>%
dplyr::summarise(
min_SCR_sqrt = min(SCR_sqrt, na.rm = TRUE),
n_negative   = sum(SCR_sqrt < 0, na.rm = TRUE)
)
## -------- acquisition: CS * TUS * TRIAL --------
res_acq_triple <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS + TUS + TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
source(here::here("stats","lme_models","_setup.R"))
## -------- acquisition: CS * TUS * TRIAL * EXPERIMENT --------
res_acq_4way <- run_lmer_test(
data_name   = "scr_df_exp_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL * EXPERIMENT + (1 + CS + TUS + TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL:EXPERIMENT"
)
## -------- acquisition (TIME: early) : CS * TUS * EXPERIMENT --------
res_acq_time_early <- run_lmer_test(
data_name   = "scr_df_exp_acq_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS * EXPERIMENT + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS:EXPERIMENT"
)
# emmeans & contrast
emm <- emmeans(res_acq_time_early$model, ~ CS * TUS * EXPERIMENT, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
aov_tab <- anova(res_acq_time_early$model)
effectsize::eta_squared(aov_tab, partial = TRUE)
## -------- acquisition (TIME: mid) : CS * TUS * EXPERIMENT --------
run_lmer_test(
data_name   = "scr_df_exp_acq_CS_TUS_mid",
formula     = SCR_sqrt_meanTime ~ CS * TUS * EXPERIMENT + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS:EXPERIMENT"
)
## -------- acquisition (TIME: late) : CS * TUS * EXPERIMENT --------
run_lmer_test(
data_name   = "scr_df_exp_acq_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS * EXPERIMENT + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS:EXPERIMENT"
)
## -------- extinction (TIME: early) : CS * TUS * EXPERIMENT --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_exp_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS * EXPERIMENT + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS:EXPERIMENT"
)
emm <- emmeans(res_ext_time_early$model, ~ CS * TUS * EXPERIMENT, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
aov_tab <- anova(res_ext_time_early$model)
effectsize::eta_squared(aov_tab, partial = TRUE)
## -------- extinction (TIME: late) : CS * TUS * EXPERIMENT --------
run_lmer_test(
data_name   = "scr_df_exp_ext_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS * EXPERIMENT + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS:EXPERIMENT"
)
## -------- acquisition: CS * TUS * TRIAL --------
res_acq_triple <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
# Emtrends on TRIAL by TUS within CS
trend_results <- emtrends(res_acq_triple$model,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
trend_results
## -------- acquisition: CS * TUS (TIME: early/mid/late) --------
# early
res_acq_early <- run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_acq_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise")
cn
# mid
run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS_mid",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
effect_name = "CS:TUS"
)
# late
run_lmer_test(
data_name   = "scr_df_amy_acq_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
effect_name = "CS:TUS"
)
## -------- threat retention: RETENT * CS * TUS --------
run_lmer_test(
data_name   = "scr_df_amy_ret_CS_TUS",
formula     = SCR_sqrt ~ RETENT * CS * TUS + (1 + RETENT + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
## -------- extinction: CS * TUS * TRIAL --------
res_ext_triple <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
emmeans(res_ext_time_early$model, pairwise ~ TUS | CS, re_formula = NULL)
## -------- extinction (early trials): CS * TUS * TRIAL --------
mod_ext_early_trial <- lmer(
SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
data = get_df("scr_df_amy_ext_CS_TUS_early_trial"),
control = ctrl_nlopt
)
emtrends(mod_ext_early_trial,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
mod_ext_early_trial
## -------- extinction: CS * TUS (TIME: late) --------
res_ext_time_late <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_late$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
## -------- extinction (early trials): CS * TUS * TRIAL --------
mod_ext_early_trial <- lmer(
SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
data = get_df("scr_df_amy_ext_CS_TUS_early_trial"),
control = ctrl_nlopt
)
emtrends(mod_ext_early_trial,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
View(model_results)
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
## -------- extinction (early trials): CS * TUS * TRIAL --------
mod_ext_early_trial <- lmer(
SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
data = get_df("scr_df_amy_ext_CS_TUS_early_trial"),
control = ctrl_nlopt
)
## -------- extinction (early trials): CS * TUS * TRIAL --------
mod_ext_early_trial <- run_lmer_test(
SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
data = get_df("scr_df_amy_ext_CS_TUS_early_trial"),
control = ctrl_nlopt
)
mod_ext_early_trial <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early_trial",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
emtrends(mod_ext_early_trial,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
emtrends(mod_ext_early_trial$model,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
## -------- extinction: CS * TUS (TIME: late) --------
res_ext_time_late <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_late$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS * TUS | SUBID),
effect_name = "CS:TUS"
)
## -------- extinction (early trials): CS * TUS * TRIAL --------
mod_ext_early_trial <- lmer(
SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
data = get_df("scr_df_amy_ext_CS_TUS_early_trial"),
control = ctrl_nlopt
)
mod_ext_early_trial
emtrends(mod_ext_early_trial,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
## -------- extinction: CS * TUS (TIME: late) --------
res_ext_time_late <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_late",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_late$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
emmeans(res_ext_time_early$model, pairwise ~ TUS | CS, re_formula = NULL)
## -------- extinction (early trials): CS * TUS * TRIAL --------
mod_ext_early_trial <- lmer(
SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
data = get_df("scr_df_amy_ext_CS_TUS_early_trial"),
control = ctrl_nlopt
)
emtrends(mod_ext_early_trial,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
emm <- emmeans(res_ext_time_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise")
cn  <- contrast(emm, interaction = "revpairwise"); cn
## -------- extinction: CS * TUS (TIME: early) --------
res_ext_time_early <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS_early",
formula     = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
effect_name = "CS:TUS"
)
emm <- emmeans(res_ext_time_early$model, ~ CS * TUS, re_formula = NULL)
cn  <- contrast(emm, interaction = "revpairwise"); cn
emmeans(res_ext_time_early$model, pairwise ~ TUS | CS, re_formula = NULL)
## -------- extinction: CS * TUS * TRIAL --------
res_ext_triple <- run_lmer_test(
data_name   = "scr_df_amy_ext_CS_TUS",
formula     = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
effect_name = "CS:TUS:TRIAL"
)
trend_results <- emtrends(res_ext_triple$model,
pairwise ~ TUS | CS,
var = "TRIAL",
re_formula = NULL)
trend_results
