TUS == "sham")
d <- cs_quest_df %>%
filter(EXPERIMENT == "hippocampus", TUS == "sham")
model <- lmer(
CS_VALENCE ~ CS + (1 + CS | SUBID),
data = d,
control = ctrl_nlopt
)
load("/Users/sjoerd.meijer/Documents/amyTUS/data/cs_quest_df.RData")
library(dplyr)
load("/Volumes/project/3023001.06/experiments/scr_df.RData")
cue_df <- scr_df
load("/Users/sjoerd.meijer/Documents/amyTUS/data/scr_df.RData")
# Build a unique lookup from scr_df: one row per (EXPERIMENT, SUBID, CUE)
scr_lookup <- scr_df %>%
mutate(CUE = as.character(CUE)) %>%     # ensure same type as cs_quest_df
select(EXPERIMENT, SUBID, CUE, CS, TUS) %>%
distinct()
# (optional) check for duplicates; resolve if needed
dup_keys <- scr_lookup %>%
count(EXPERIMENT, SUBID, CUE) %>%
filter(n > 1)
if (nrow(dup_keys) > 0) {
scr_lookup <- scr_df %>%
mutate(CUE = as.character(CUE)) %>%
group_by(EXPERIMENT, SUBID, CUE) %>%
summarise(
# choose the most frequent label per key (robust if minor inconsistencies exist)
CS  = names(which.max(table(CS))),
TUS = names(which.max(table(TUS))),
.groups = "drop"
)
}
library(dplyr)
# Build a unique lookup from scr_df: one row per (EXPERIMENT, SUBID, CUE)
scr_lookup <- scr_df %>%
mutate(CUE = as.character(CUE)) %>%     # ensure same type as cs_quest_df
select(EXPERIMENT, SUBID, CUE, CS, TUS) %>%
distinct()
# --- load data (as you had) ---
load("/Users/sjoerd.meijer/Documents/amyTUS/data/cs_quest_df.RData")
library(dplyr)
load("/Volumes/project/3023001.06/experiments/scr_df.RData")
cue_df <- scr_df
load("/Users/sjoerd.meijer/Documents/amyTUS/data/scr_df.RData")
# --- renumber SUBID within each experiment (unchanged) ---
cue_df <- cue_df %>%
ungroup() %>%
group_by(EXPERIMENT) %>%
mutate(SUBID = sprintf("%02d", as.numeric(factor(SUBID)))) %>%
ungroup()
# --- Build a unique lookup: one CUE per (EXPERIMENT, SUBID, CS, TUS) (unchanged) ---
cue_lookup <- cue_df %>%
ungroup() %>%
select(EXPERIMENT, SUBID, CS, TUS, CUE) %>%
distinct()
# Optional duplicate check (unchanged)
dup_keys <- cue_lookup %>%
count(EXPERIMENT, SUBID, CS, TUS) %>%
filter(n > 1)
if (nrow(dup_keys) > 0) {
# Resolve duplicates by choosing the most frequent CUE per key (unchanged)
cue_lookup <- cue_df %>%
ungroup() %>%
select(EXPERIMENT, SUBID, CS, TUS, CUE) %>%
group_by(EXPERIMENT, SUBID, CS, TUS) %>%
summarise(CUE = as.integer(names(which.max(table(CUE)))), .groups = "drop")
}
# --- Join CUE into scr_df without expanding rows (unchanged) ---
scr_df <- scr_df %>%
left_join(cue_lookup, by = c("EXPERIMENT", "SUBID", "CS", "TUS"))
# --- Build lookup per (EXPERIMENT, SUBID, CUE) and include BOTH TUS and CS (CHANGED) ---
# First ensure CUE types match later joins (coerce to character)
scr_lookup <- scr_df %>%
mutate(CUE = as.character(CUE)) %>%
select(EXPERIMENT, SUBID, CUE, TUS, CS) %>%
distinct()
# Optional: sanity check uniqueness (same step as before, now for both TUS & CS)
dup_keys2 <- scr_lookup %>%
count(EXPERIMENT, SUBID, CUE) %>%
filter(n > 1)
if (nrow(dup_keys2) > 0) {
# Resolve by taking the most frequent label per key (robust to minor inconsistencies)
scr_lookup <- scr_df %>%
mutate(CUE = as.character(CUE)) %>%
group_by(EXPERIMENT, SUBID, CUE) %>%
summarise(
TUS = names(which.max(table(TUS))),
CS  = names(which.max(table(CS))),
.groups = "drop"
)
}
# --- Join into cs_quest_df without growing it (CHANGED: adds both TUS and CS) ---
cs_quest_df <- cs_quest_df %>%
mutate(CUE = as.character(CUE)) %>%
left_join(scr_lookup, by = c("EXPERIMENT", "SUBID", "CUE"))
model <- lmer(
CS_VALENCE ~ CS + (1 + CS | SUBID),
data = d,
control = ctrl_nlopt
)
d <- cs_quest_df %>%
filter(EXPERIMENT == "hippocampus", TUS == "sham")
model <- lmer(
CS_VALENCE ~ CS + (1 + CS | SUBID),
data = d,
control = ctrl_nlopt
)
model <- lmer(
CS_VALENCE ~ CS + (1 | SUBID),
data = d,
control = ctrl_nlopt
)
anova(model)
df <- cs_quest_df %>%
filter(EXPERIMENT == "hippocampus",
TUS == "sham")
model <- lmer(
CS_VALENCE ~ CS + (1 | SUBID),
data = df,
control = ctrl_nlopt
)
anova(model)
emm <- emmeans(model, ~ CS, re_formula = NULL)
emmeans(model, ~ CS, re_formula = NULL)
emmeans(model, ~ CS, re_formula = NULL)
df_wide <- tidyr::pivot_wider(
df,
names_from = CS,
values_from = CS_VALENCE
)
# Run paired t-test
t_test_res <- t.test(df_wide$threat, df_wide$control, paired = TRUE)
t_test_res
model <- lmer(
CS_VALENCE ~ CS + (1 | SUBID),
data = df,
control = ctrl_nlopt
)
anova(model)
# make sure TUS and CS are factors
cs_quest_df <- cs_quest_df %>%
mutate(
CS = factor(CS),
TUS = factor(TUS)
)
# compute threat-control difference per subject and TUS
cs_diff_df <- cs_quest_df %>%
group_by(EXPERIMENT, SUBID, TUS, CS) %>%
summarise(CS_VALENCE = mean(CS_VALENCE, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(names_from = CS, values_from = CS_VALENCE) %>%
mutate(diff_valence = threat - control)
# run separate one-sample t-tests per TUS condition
cs_diff_df %>%
group_by(EXPERIMENT, TUS) %>%
summarise(
t = t.test(diff_valence, mu = 0)$statistic,
df = t.test(diff_valence, mu = 0)$parameter,
p  = t.test(diff_valence, mu = 0)$p.value,
mean_diff = mean(diff_valence, na.rm = TRUE),
.groups = "drop"
)
library(dplyr)
library(tidyr)
library(purrr)
library(broom)
# Compute threat - control difference scores per subject and TUS, for all three variables
cs_diff_df <- cs_quest_df %>%
group_by(EXPERIMENT, SUBID, TUS, CS) %>%
summarise(
CS_VALENCE = mean(CS_VALENCE, na.rm = TRUE),
CS_AROUSAL = mean(CS_AROUSAL, na.rm = TRUE),
CS_SHOCK   = mean(CS_SHOCK,   na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = CS,
values_from = c(CS_VALENCE, CS_AROUSAL, CS_SHOCK)
) %>%
mutate(
diff_valence = CS_VALENCE_threat - CS_VALENCE_control,
diff_arousal = CS_AROUSAL_threat - CS_AROUSAL_control,
diff_shock   = CS_SHOCK_threat   - CS_SHOCK_control
)
# Run one-sample t-tests (vs 0) for each measure per experiment × TUS
cs_ttests_df <- cs_diff_df %>%
group_by(EXPERIMENT, TUS) %>%
summarise(
across(
starts_with("diff_"),
list(
mean = ~ mean(.x, na.rm = TRUE),
t    = ~ t.test(.x, mu = 0)$statistic,
df   = ~ t.test(.x, mu = 0)$parameter,
p    = ~ t.test(.x, mu = 0)$p.value
),
.names = "{.col}_{.fn}"
),
.groups = "drop"
)
cs_ttests_df
# Compute threat–control difference per subject and TUS for all measures
cs_diff_df <- cs_quest_df %>%
group_by(EXPERIMENT, SUBID, TUS, CS) %>%
summarise(
CS_VALENCE = mean(CS_VALENCE, na.rm = TRUE),
CS_AROUSAL = mean(CS_AROUSAL, na.rm = TRUE),
CS_SHOCK   = mean(CS_SHOCK,   na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = CS,
values_from = c(CS_VALENCE, CS_AROUSAL, CS_SHOCK)
) %>%
mutate(
diff_valence = CS_VALENCE_threat - CS_VALENCE_control,
diff_arousal = CS_AROUSAL_threat - CS_AROUSAL_control,
diff_shock   = CS_SHOCK_threat   - CS_SHOCK_control
)
# Run one-sample t-tests per measure × experiment × TUS
cs_ttests_df <- cs_diff_df %>%
group_by(EXPERIMENT, TUS) %>%
summarise(
across(
starts_with("diff_"),
list(
mean = ~ mean(.x, na.rm = TRUE),
t    = ~ t.test(.x, mu = 0)$statistic,
df   = ~ t.test(.x, mu = 0)$parameter,
p    = ~ t.test(.x, mu = 0)$p.value
),
.names = "{.col}_{.fn}"
),
.groups = "drop"
)
# Format and print results nicely
cs_ttests_df %>%
mutate(
across(ends_with("_p"), ~ ifelse(.x < 0.0001, "<0.0001",
sprintf("%.4f", .x))),
across(ends_with("_t"), ~ sprintf("%.2f", .x)),
across(ends_with("_df"), ~ sprintf("%.0f", .x))
) %>%
rowwise() %>%
mutate(
output_valence = paste0(
"Valence - ", EXPERIMENT, " - ", TUS,
" TUS: t(", diff_valence_df, ") = ", diff_valence_t,
", p = ", diff_valence_p
),
output_arousal = paste0(
"Arousal - ", EXPERIMENT, " - ", TUS,
" TUS: t(", diff_arousal_df, ") = ", diff_arousal_t,
", p = ", diff_arousal_p
),
output_shock = paste0(
"Shock expectancy - ", EXPERIMENT, " - ", TUS,
" TUS: t(", diff_shock_df, ") = ", diff_shock_t,
", p = ", diff_shock_p
)
) %>%
ungroup() %>%
select(output_valence, output_arousal, output_shock) %>%
mutate(title = "CS threat–control difference tests") %>%
relocate(title) %>%
print(n = Inf)
# --- Compute threat–control difference per subject and TUS for all measures ---
cs_diff_df <- cs_quest_df %>%
group_by(EXPERIMENT, SUBID, TUS, CS) %>%
summarise(
CS_VALENCE = mean(CS_VALENCE, na.rm = TRUE),
CS_AROUSAL = mean(CS_AROUSAL, na.rm = TRUE),
CS_SHOCK   = mean(CS_SHOCK,   na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = CS,
values_from = c(CS_VALENCE, CS_AROUSAL, CS_SHOCK)
) %>%
mutate(
diff_valence = CS_VALENCE_threat - CS_VALENCE_control,
diff_arousal = CS_AROUSAL_threat - CS_AROUSAL_control,
diff_shock   = CS_SHOCK_threat   - CS_SHOCK_control
)
# --- Run one-sample t-tests (vs 0) per measure × experiment × TUS ---
cs_ttests_df <- cs_diff_df %>%
group_by(EXPERIMENT, TUS) %>%
summarise(
across(
starts_with("diff_"),
list(
mean = ~ mean(.x, na.rm = TRUE),
t    = ~ t.test(.x, mu = 0)$statistic,
df   = ~ t.test(.x, mu = 0)$parameter,
p    = ~ t.test(.x, mu = 0)$p.value
),
.names = "{.col}_{.fn}"
),
.groups = "drop"
)
# --- Reformat and print each condition × measure as a separate row ---
cs_ttests_long <- cs_ttests_df %>%
mutate(
across(ends_with("_p"), ~ ifelse(.x < 0.0001, "<0.0001",
sprintf("%.4f", .x))),
across(ends_with("_t"), ~ sprintf("%.2f", .x)),
across(ends_with("_df"), ~ sprintf("%.0f", .x))
) %>%
select(EXPERIMENT, TUS,
diff_valence_t, diff_valence_df, diff_valence_p,
diff_arousal_t, diff_arousal_df, diff_arousal_p,
diff_shock_t, diff_shock_df, diff_shock_p) %>%
pivot_longer(
cols = starts_with("diff_"),
names_to = c("measure", ".value"),
names_pattern = "diff_(.*)_(t|df|p)"
) %>%
mutate(
measure = recode(measure,
valence = "Valence",
arousal = "Arousal",
shock   = "Shock expectancy"),
sentence = paste0(
measure, " - ", EXPERIMENT, " - ", TUS,
" TUS: t(", df, ") = ", t, ", p = ", p
)
) %>%
select(EXPERIMENT, TUS, measure, sentence)
# --- Print neatly ---
cat("\nCS threat–control difference tests:\n")
cs_ttests_long %>%
arrange(EXPERIMENT, TUS, measure) %>%
pull(sentence) %>%
paste(collapse = "\n") %>%
cat()
# ---- Setup ----
suppressPackageStartupMessages({
library(lme4)
library(lmerTest)
library(emmeans)
library(effectsize)   # for eta_squared()
library(glue)
library(dplyr)
library(tidyr)
library(purrr)
})
options(contrasts = c("contr.sum", "contr.poly"))
fit_lmer <- function(formula, data, control = NULL) {
if (is.null(control)) control <- lmerControl(optimizer = "nloptwrap")
lmer(formula, data = data, control = control)
}
extract_anova_term <- function(model, term) {
a <- anova(model)
stopifnot(term %in% rownames(a))
tibble(
term   = term,
F      = as.numeric(a[term, "F value"]),
df1    = as.numeric(a[term, "NumDF"]),
df2    = as.numeric(a[term, "DenDF"]),
p      = as.numeric(a[term, "Pr(>F)"]),
t_from_F = sqrt(as.numeric(a[term, "F value"]))
)
}
extract_eta2p <- function(model, term) {
e <- eta_squared(model, partial = TRUE)
row <- e[e$Parameter == term, , drop = FALSE]
tibble(eta2p = if (nrow(row)) as.numeric(row$Eta2_partial) else NA_real_)
}
fmt_p <- function(p) ifelse(is.na(p), "NA",
ifelse(p < 1e-4, "<0.0001", sprintf("%.4f", p)))
fmt_num <- function(x, d = 2) sprintf(paste0("%.", d, "f"), x)
report_line <- function(data_name, formula_chr, term, anov, eta) {
glue(
"Data: {data_name}\nModel: {formula_chr}\nStats: F({anov$df1}, {round(anov$df2)}) = {fmt_num(anov$F)}, p = {fmt_p(anov$p)}, ηₚ² = {fmt_num(eta$eta2p)}"
)
}
run_emmeans_contrast <- function(model, spec = ~ CS * TUS, interaction = "revpairwise") {
emm <- emmeans(model, spec, re_formula = NULL)
contrast(emm, interaction = interaction)
}
run_emtrends_pairwise <- function(model, pairwise_spec = pairwise ~ TUS | CS, var = "TRIAL") {
emtrends(model, pairwise_spec, var = var, re_formula = NULL)
}
dz_from_t <- function(t, n) t / sqrt(n)
# ---- Registry of analyses (edit/extend as needed) ----
# Each entry: data object name, formula, term to report, label for printing
RUNS <- list(
list(
label = "acquisition: CS * TUS * TRIAL",
data  = scr_df_amy_acq_CS_TUS,
form  = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
term  = "CS:TUS:TRIAL",
extras = list(
trends = TRUE,     # emtrends by TRIAL
contrasts = FALSE
)
),
list(
label = "acquisition: CS * TUS (early)",
data  = scr_df_amy_acq_CS_TUS_early,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
),
list(
label = "acquisition: CS * TUS (mid)",
data  = scr_df_amy_acq_CS_TUS_mid,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
),
list(
label = "acquisition: CS * TUS (late)",
data  = scr_df_amy_acq_CS_TUS_late,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS | SUBID) + (1 + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
),
list(
label = "threat retention: REINST * CS * TUS",
data  = scr_df_amy_ret_CS_TUS,
form  = SCR_sqrt ~ RETENT * CS * TUS + (1 + RETENT + CS + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = FALSE, trends = FALSE, also_terms = c("REINST:CS"))
),
list(
label = "extinction: CS * TUS * TRIAL",
data  = scr_df_amy_ext_CS_TUS,
form  = SCR_sqrt ~ CS * TUS * TRIAL + (1 + CS * TUS * TRIAL | SUBID),
term  = "CS:TUS:TRIAL",
extras = list(trends = TRUE, contrasts = FALSE)
),
list(
label = "extinction early: CS * TUS",
data  = scr_df_amy_ext_CS_TUS_early,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
),
list(
label = "extinction late: CS * TUS",
data  = scr_df_amy_ext_CS_TUS_late,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
),
list(
label = "re-extinction early: CS * TUS",
data  = scr_df_amy_reext_CS_TUS_early,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
),
list(
label = "re-extinction late: CS * TUS",
data  = scr_df_amy_reext_CS_TUS_late,
form  = SCR_sqrt_meanTime ~ CS * TUS + (1 + CS + TUS | SUBID),
term  = "CS:TUS",
extras = list(contrasts = TRUE, trends = FALSE)
)
)
# ---- Runner ----
results_core <- list()
results_emm  <- list()
results_trnd <- list()
for (i in seq_along(RUNS)) {
spec <- RUNS[[i]]
data_obj <- spec$data
stopifnot(is.data.frame(data_obj))
form_obj <- spec$form
message("\n--- ", spec$label, " ---")
model <- fit_lmer(form_obj, data_obj, control = ctrl_nlopt)
anov  <- extract_anova_term(model, spec$term)
eta   <- extract_eta2p(model, spec$term)
cat(
report_line(
data_name   = deparse(substitute(data_obj)),
formula_chr = deparse(form_obj),
term        = spec$term,
anov        = anov,
eta         = eta
),
"\n"
)
# store core
results_core[[spec$label]] <- tibble(
label = spec$label,
data  = deparse(substitute(data_obj)),
formula = deparse(form_obj),
term = spec$term,
F = anov$F,
df1 = anov$df1,
df2 = anov$df2,
p = anov$p,
t_equiv = anov$t_from_F,
eta2p = eta$eta2p
)
# optional: emmeans contrasts
if (isTRUE(spec$extras$contrasts)) {
cn <- run_emmeans_contrast(model, spec = ~ CS * TUS, interaction = "revpairwise")
print(cn)
results_emm[[spec$label]] <- as_tibble(cn)
}
# optional: emtrends on TRIAL slopes
if (isTRUE(spec$extras$trends)) {
tr <- run_emtrends_pairwise(model, pairwise_spec = pairwise ~ TUS | CS, var = "TRIAL")
print(tr)
results_trnd[[spec$label]] <- list(summary = tr$emtrends, pairs = tr$`pairwise differences`)
}
# optional: report example Cohen's dz if you have a specific t & n
# cat("Example dz from t: ", fmt_num(dz_from_t(t = 2.813, n = 25)), "\n")
}
