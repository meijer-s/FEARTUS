#### LOAD DATAFRAME ####
load("/Users/sjoerd.meijer/Documents/amyTUS/data/scr_df.RData")

PHASE_filter <- c("extinction", "retention")
US_filter <- "unreinforced"

df <- scr_df %>%
  filter(PHASE %in% PHASE_filter,
         US == US_filter)

# Step 1: Summarize and calculate the mean_SCR_sqrt for each SUBID, TRIAL, and CS
SUBID_difference <- df %>%
  group_by(EXPERIMENT, SUBID, TRIAL, TUS, CS) %>%
  dplyr::summarise(
    mean_SCR_sqrt = mean(SCR_sqrt, na.rm = TRUE),
    .groups = 'drop'  # Avoid grouping in the resulting data frame
  )

# Step 2: Separate data based on CS condition (control or threat)
amygdala_sham_safety_df <- SUBID_difference %>% filter(EXPERIMENT == "amygdala", TUS == "sham", CS == "control")
amygdala_sham_threat_df <- SUBID_difference %>% filter(EXPERIMENT == "amygdala", TUS == "sham", CS == "threat")
amygdala_active_safety_df <- SUBID_difference %>% filter(EXPERIMENT == "amygdala", TUS == "active", CS == "control")
amygdala_active_threat_df <- SUBID_difference %>% filter(EXPERIMENT == "amygdala", TUS == "active", CS == "threat")
hippocampus_sham_safety_df <- SUBID_difference %>% filter(EXPERIMENT == "hippocampus", TUS == "sham", CS == "control")
hippocampus_sham_threat_df <- SUBID_difference %>% filter(EXPERIMENT == "hippocampus", TUS == "sham", CS == "threat")
hippocampus_active_safety_df <- SUBID_difference %>% filter(EXPERIMENT == "hippocampus", TUS == "active", CS == "control")
hippocampus_active_threat_df <- SUBID_difference %>% filter(EXPERIMENT == "hippocampus", TUS == "active", CS == "threat")

# Step 3: Reshape data so that each SUBID has rows with TRIAL as columns
# For safety (control) condition
amygdala_sham_safety_df_wide <- amygdala_sham_safety_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For threat condition
amygdala_sham_threat_df_wide <- amygdala_sham_threat_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For safety (control) condition
amygdala_active_safety_df_wide <- amygdala_active_safety_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For threat condition
amygdala_active_threat_df_wide <- amygdala_active_threat_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For safety (control) condition
hippocampus_sham_safety_df_wide <- hippocampus_sham_safety_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For threat condition
hippocampus_sham_threat_df_wide <- hippocampus_sham_threat_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For safety (control) condition
hippocampus_active_safety_df_wide <- hippocampus_active_safety_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)

# For threat condition
hippocampus_active_threat_df_wide <- hippocampus_active_threat_df %>%
  pivot_wider(
    names_from = TRIAL,        # The columns will be the trial numbers
    values_from = mean_SCR_sqrt,  # Values in these columns are the mean_SCR_sqrt
    names_prefix = "TRIAL_"   # Prefix to indicate the trials
  ) %>% 
  select(-SUBID, -CS, -TUS, -EXPERIMENT)


# Define the path where you want to save the files
save_path <- "/Users/sjoerd.meijer/Documents/amyTUS/code/permutation_tests/palm_data/extinction/"

# Save the dataframes
save(amygdala_sham_safety_df_wide, file = paste0(save_path, "amygdala_sham_safety_df_wide.RData"))
save(amygdala_sham_threat_df_wide, file = paste0(save_path, "amygdala_sham_threat_df_wide.RData"))
save(amygdala_active_safety_df_wide, file = paste0(save_path, "amygdala_active_safety_df_wide.RData"))
save(amygdala_active_threat_df_wide, file = paste0(save_path, "amygdala_active_threat_df_wide.RData"))
save(hippocampus_sham_safety_df_wide, file = paste0(save_path, "hippocampus_sham_safety_df_wide.RData"))
save(hippocampus_sham_threat_df_wide, file = paste0(save_path, "hippocampus_sham_threat_df_wide.RData"))
save(hippocampus_active_safety_df_wide, file = paste0(save_path, "hippocampus_active_safety_df_wide.RData"))
save(hippocampus_active_threat_df_wide, file = paste0(save_path, "hippocampus_active_threat_df_wide.RData"))


# Define the path where the files are saved
data_path <- "/Users/sjoerd.meijer/Documents/amyTUS/code/permutation_tests/palm_data/extinction/"

# Load all the RData files
load(paste0(data_path, "amygdala_sham_safety_df_wide.RData"))
load(paste0(data_path, "amygdala_sham_threat_df_wide.RData"))
load(paste0(data_path, "amygdala_active_safety_df_wide.RData"))
load(paste0(data_path, "amygdala_active_threat_df_wide.RData"))
load(paste0(data_path, "hippocampus_sham_safety_df_wide.RData"))
load(paste0(data_path, "hippocampus_sham_threat_df_wide.RData"))
load(paste0(data_path, "hippocampus_active_safety_df_wide.RData"))
load(paste0(data_path, "hippocampus_active_threat_df_wide.RData"))



##### DATA #####

data_wide <- rbind(amygdala_sham_threat_df_wide, amygdala_sham_safety_df_wide)

print(data_wide, N = Inf)

# Write the data to a CSV file
write.table(data_wide, 
            file = "/Users/sjoerd.meijer/Documents/amyTUS/code/permutation_tests/palm_files/amygdala/amy_ext_sham_unr_CS/data_amy_ext_sham_unr_CS.csv", 
            row.names = FALSE, 
            col.names = FALSE,  # This will exclude column names
            sep = ",")  # Ensure the separator is a comma

##### EXCHANGABILITY BLOCKS #####

# Number of subjects
subjects <- 25

# Generate the data frame for SUBJECT, TRIAL, and CONDITION
exchange_blocks <- expand.grid(
  EXPERIMENT = -1,  # Add EXPERIMENT column directly
  SUBJECT = rep(1:25, 2)  # Repeats 1 to 25 two times
)

# Add the CS column
exchange_blocks$CS <- rep(c(1, 2), each = subjects)

# Rearrange columns to ensure the top-level grouping column is first
exchangeability_file <- exchange_blocks[, c("EXPERIMENT", "SUBJECT", "CS")]

print(exchangeability_file, N = Inf)

# Write the exchangeability blocks file to a CSV
write.table(exchangeability_file, 
            file = "/Users/sjoerd.meijer/Documents/amyTUS/code/permutation_tests/palm_files/amygdala/amy_ext_sham_unr_CS/blocks_amy_ext_sham_unr_CS.csv", 
            row.names = FALSE, 
            col.names = FALSE, 
            sep = ",")


##### DESIGN MATRIX #####

subjects <- 25
conditions <- 2

# Number of total rows (subject * trials * conditions)
total_rows <- subjects *  conditions
total_cols <- subjects + 1 # CS

# Initialize an empty matrix for the design matrix
design_matrix <- matrix(0, nrow = total_rows, ncol = total_cols)

# CS: threat
design_matrix[1:25, 1] <- 1
# CS: safety
design_matrix[26:50, 1] <- -1

subjects <- 25

# Add subject identity columns (each subject will have a column with 1 in their row and 0 elsewhere)
for (i in 1:subjects) {
  design_matrix[i, i + 1] <- 1  # Row 1 to 25: subject 1 to 25
  design_matrix[25 + i, i + 1] <- 1  # Row 26 to 50: subject 1 to 25
}

# Convert to a data frame and check the structure
design_matrix_df <- as.data.frame(design_matrix)
print(design_matrix_df, N = Inf)


# Write the design matrix to a CSV file
write.table(design_matrix_df, 
            file = "/Users/sjoerd.meijer/Documents/amyTUS/code/permutation_tests/palm_files/amygdala/amy_ext_sham_unr_CS/design_amy_ext_sham_unr_CS.csv", 
            row.names = FALSE, 
            col.names = FALSE,  # This will exclude column names
            sep = ",")  # Ensure the separator is a comma

##### CONTRAST MATRIX #####

# Initialize the contrast matrix with 0s (1 row, total_cols columns)
contrast_matrix <- matrix(0, nrow = 1, ncol = total_cols)

# Set the contrast for the first column (condition)
contrast_matrix[1, 1] <- 1  # CS

# Convert to a data frame and save as a CSV file
contrast_matrix_df <- as.data.frame(contrast_matrix)

print(contrast_matrix_df, N = Inf)

write.table(contrast_matrix_df, 
            file = "/Users/sjoerd.meijer/Documents/amyTUS/code/permutation_tests/palm_files/amygdala/amy_ext_sham_unr_CS/contrast_amy_ext_sham_unr_CS.csv", 
            row.names = FALSE, 
            col.names = FALSE,  # This will exclude column names
            sep = ",")  # Ensure the separator is a comma
